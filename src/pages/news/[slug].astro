---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

export const prerender = false;

const { slug } = Astro.params;

const { data: article } = await supabase
  .from('news_articles')
  .select('*')
  .eq('slug', slug)
  .eq('is_published', true)
  .single();

if (!article) {
  return Astro.redirect('/404');
}

const { data: relatedArticles } = await supabase
  .from('news_articles')
  .select('id, slug, title, excerpt, featured_image, published_at')
  .eq('is_published', true)
  .neq('id', article.id)
  .order('published_at', { ascending: false })
  .limit(3);
---

<Layout
  title={article.meta_title || article.title}
  description={article.meta_description || article.excerpt}
>
  <div class="bg-white">
    <div class="max-w-4xl mx-auto py-16 px-4 sm:px-6 lg:px-8">
      <article>
        {article.featured_image && (
          <img
            src={article.featured_image}
            alt={article.title}
            class="w-full h-96 object-cover rounded-lg mb-8"
          />
        )}

        <div class="mb-6">
          <p class="text-sm text-gray-500 mb-2">
            {new Date(article.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
          <h1 class="text-4xl font-extrabold text-gray-900 mb-4">{article.title}</h1>
          {article.excerpt && (
            <p class="text-xl text-gray-600 mb-8">{article.excerpt}</p>
          )}
        </div>

        <div class="prose prose-lg max-w-none">
          <Fragment set:html={article.content} />
        </div>
      </article>

      {relatedArticles && relatedArticles.length > 0 && (
        <div class="mt-16 border-t pt-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-8">Related Articles</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {relatedArticles.map((related) => (
              <a href={`/news/${related.slug}`} class="group">
                {related.featured_image && (
                  <img
                    src={related.featured_image}
                    alt={related.title}
                    class="w-full h-32 object-cover rounded-lg mb-3"
                  />
                )}
                <h3 class="font-bold text-gray-900 group-hover:text-primary mb-2">{related.title}</h3>
                <p class="text-sm text-gray-600">{related.excerpt}</p>
              </a>
            ))}
          </div>
        </div>
      )}

      <div class="mt-8">
        <a href="/news" class="text-primary hover:text-primary/80 font-medium">
          ‚Üê Back to News
        </a>
      </div>
    </div>
  </div>
</Layout>
