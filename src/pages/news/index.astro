---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

export const prerender = false;

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const perPage = 12;
const offset = (page - 1) * perPage;

const { data: articles, count } = await supabase
  .from('news_articles')
  .select('*', { count: 'exact' })
  .eq('is_published', true)
  .order('published_at', { ascending: false })
  .range(offset, offset + perPage - 1);

const totalPages = Math.ceil((count || 0) / perPage);
---

<Layout title="News & Insights - Circular Horizons International">
  <div class="bg-white">
    <div class="max-w-7xl mx-auto py-16 px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl">News & Insights</h1>
        <p class="mt-4 text-xl text-gray-600 max-w-2xl mx-auto">
          Stay updated with the latest trends, insights, and news from the world of sustainability and circular economy.
        </p>
      </div>

      {articles && articles.length > 0 ? (
        <>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {articles.map((article) => (
              <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                {article.featured_image && (
                  <img src={article.featured_image} alt={article.title} class="w-full h-48 object-cover" />
                )}
                <div class="p-6">
                  <p class="text-sm text-gray-500 mb-2">
                    {new Date(article.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                  </p>
                  <h2 class="text-xl font-bold text-gray-900 mb-3">{article.title}</h2>
                  <p class="text-gray-600 mb-4">{article.excerpt}</p>
                  <a href={`/news/${article.slug}`} class="inline-flex items-center text-primary font-medium hover:text-primary/80">
                    Read More
                    <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </a>
                </div>
              </article>
            ))}
          </div>

          {totalPages > 1 && (
            <div class="mt-12 flex justify-center gap-2">
              {page > 1 && (
                <a href={`/news?page=${page - 1}`} class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Previous</a>
              )}
              {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
                <a
                  href={`/news?page=${p}`}
                  class={`px-4 py-2 border rounded-md ${p === page ? 'bg-primary text-white border-primary' : 'border-gray-300 hover:bg-gray-50'}`}
                >
                  {p}
                </a>
              ))}
              {page < totalPages && (
                <a href={`/news?page=${page + 1}`} class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Next</a>
              )}
            </div>
          )}
        </>
      ) : (
        <div class="text-center text-gray-500 py-12">No articles published yet.</div>
      )}
    </div>
  </div>
</Layout>
