---
import AdminLayout from '../../../layouts/AdminLayout.astro';

export const prerender = false;

const id = Astro.url.searchParams.get('id');
const isNew = id === 'new';
---

<AdminLayout title={isNew ? "Create Article" : "Edit Article"}>
  <div>
    <h1 class="text-3xl font-bold text-gray-900 mb-8">{isNew ? 'Create' : 'Edit'} Article</h1>
    <form id="article-form" class="space-y-6">
      <div class="bg-white rounded-lg shadow p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input type="text" id="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
          <input type="text" id="slug" required class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
          <textarea id="excerpt" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Featured Image URL</label>
          <input type="url" id="featured_image" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Content (HTML)</label>
          <textarea id="content" rows="15" class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm"></textarea>
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="is_published" class="h-4 w-4 text-primary rounded" />
          <label for="is_published" class="ml-2 text-sm text-gray-700">Published</label>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 space-y-4">
        <h3 class="text-lg font-bold">SEO</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Meta Title</label>
          <input type="text" id="meta_title" class="w-full px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Meta Description</label>
          <textarea id="meta_description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-4">
        <a href="/admin/news" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</a>
        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90">Save Article</button>
      </div>
    </form>
  </div>

  <script define:vars={{ id, isNew }}>
    import { supabase } from '../../../lib/supabase';

    async function loadArticle() {
      if (isNew) return;

      const { data } = await supabase
        .from('news_articles')
        .select('*')
        .eq('id', id)
        .single();

      if (data) {
        document.getElementById('title').value = data.title || '';
        document.getElementById('slug').value = data.slug || '';
        document.getElementById('excerpt').value = data.excerpt || '';
        document.getElementById('featured_image').value = data.featured_image || '';
        document.getElementById('content').value = data.content || '';
        document.getElementById('is_published').checked = data.is_published || false;
        document.getElementById('meta_title').value = data.meta_title || '';
        document.getElementById('meta_description').value = data.meta_description || '';
      }
    }

    document.getElementById('article-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const article = {
        title: document.getElementById('title').value,
        slug: document.getElementById('slug').value,
        excerpt: document.getElementById('excerpt').value,
        featured_image: document.getElementById('featured_image').value,
        content: document.getElementById('content').value,
        is_published: document.getElementById('is_published').checked,
        meta_title: document.getElementById('meta_title').value,
        meta_description: document.getElementById('meta_description').value,
        published_at: document.getElementById('is_published').checked ? new Date().toISOString() : null
      };

      if (isNew) {
        const { error } = await supabase.from('news_articles').insert([article]);
        if (!error) window.location.href = '/admin/news';
      } else {
        const { error } = await supabase
          .from('news_articles')
          .update({ ...article, updated_at: new Date().toISOString() })
          .eq('id', id);
        if (!error) window.location.href = '/admin/news';
      }
    });

    document.getElementById('title')?.addEventListener('input', (e) => {
      const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      document.getElementById('slug').value = slug;
    });

    loadArticle();
  </script>
</AdminLayout>
